# AI Code Intake Documentation

This document explains how to import and use AI-generated animation code in the Remotion MP4 renderer.

## Overview

The system supports importing animations generated by AI models or external sources. This enables rapid prototyping and integration of third-party animations into your Remotion rendering pipeline.

## Workflow

```
1. AI Generation → Generate animation code
2. Placement → Drop code in input/<name>/
3. Validation → Run validation checks
4. Import → Copy to packages/animations-external/
5. Registration → Register in Studio app
6. Rendering → Render to MP4
```

## Step 1: AI Generation

Use the `prompts/animation-codegen.md` prompt as a guide for generating Remotion-compatible animation code.

**Key Requirements**:
- Follow the External Composition Contract
- Use `registerExternalCompositions()` export
- Props validated with Zod
- Composition metadata included

## Step 2: Placement

Create a directory for your animation in the `input/` folder:

\`\`\`bash
input/my-animation/
├── Composition.tsx          # Main component
├── props.ts                 # Props schema
├── register.ts              # Registration function
└── README.md                # Documentation
\`\`\`

**Note**: The `input/` directory is gitignored. Only place code you want to import.

## Step 3: Validation

Validate your animation before importing:

\`\`\`bash
# Validate all animations in input/
npm run intake:validate

# Validate specific animation
npm run intake:validate -- --source my-animation
\`\`\`

### Validation Checks

1. **TypeScript Compilation**: Code compiles without errors
2. **ESLint**: Code follows style guidelines
3. **Registration Function**: `registerExternalCompositions()` exists
4. **Guardrails**: No disallowed patterns (see below)

### Common Validation Errors

\`\`\`
✗ Validation failed for: my-animation
  - Required file missing: src/Composition.tsx
  - Guardrail violation: Line 5: Math.random() found
  - Guardrail violation: Line 12: window used without typeof guard
\`\`\`

**Fix the reported issues and re-run validation.**

## Step 4: Import

After validation passes, import the animation:

\`\`\`bash
# Import single animation
npm run intake:import -- --source my-animation

# Import all validated animations
npm run intake:import-all
\`\`\`

**What Import Does**:
- Copies code from `input/<name>/` to `packages/animations-external/<name>/`
- Creates package.json with proper dependencies
- Registers composition in `apps/studio/src/Root.tsx`
- Validates props schema

## Step 5: Rendering

Render the imported animation:

\`\`\`bash
# Render 2D animation
npm run render -- --comp MyAnimation --out out/my-anim.mp4

# Render 3D animation (requires --gl flag)
npm run render -- --comp My3DAnim --out out/3d.mp4 --gl swangle
\`\`\`

### Rendering with Props

Create a JSON file with props:

\`\`\`json
{
  "text": "Custom Text",
  "color": "#ff0000",
  "fontSize": 80
}
\`\`\`

Render with props:

\`\`\`bash
npm run render -- --comp MyAnimation --out out/my-anim.mp4 --props props.json
\`\`\`

## Guardrails

The system enforces these guardrails to ensure safety and determinism:

### 1. No Math.random()

**Problem**: `Math.random()` produces different output each render, breaking reproducibility.

**Solution**: Use seeded random via props:

\`\`\`typescript
// ✅ CORRECT
export const PropsSchema = z.object({
  seed: z.number().default(42)
})

export const MyAnimation: React.FC<Props> = ({seed}) => {
  const seededRandom = (seed * 9301 + 49297) % 233280
  const x = (seededRandom / 233280) * 10
  return <div style={{left: x}} />
}
\`\`\`

### 2. No fetch() Without Async

**Problem**: Network requests during rendering can timeout or error in SSR.

**Solution**: Use Remotion's `delayRender()` and `continueRender()`:

\`\`\`typescript
// ✅ CORRECT
import {delayRender, continueRender} from 'remotion'

export const MyAnimation: React.FC = () => {
  const frame = useCurrentFrame()
  const handle = delayRender()

  const loadData = async () => {
    const response = await fetch('/api/data')
    const data = await response.json()
    continueRender(handle)
    return data
  }

  const data = await loadData()

  return <div>{data}</div>
}
\`\`\`

### 3. No window/document Without Guard

**Problem**: `window` and `document` don't exist in Node.js SSR, causing crashes.

**Solution**: Always use `typeof` guard:

\`\`\`typescript
// ✅ CORRECT
export const MyAnimation: React.FC = () => {
  const frame = useCurrentFrame()

  if (typeof window !== 'undefined') {
    // Safe to use window here
    const w = window.innerWidth
  }

  return <div>Content</div>
}
\`\`\`

### 4. No eval() or Function()

**Problem**: Arbitrary code execution is a major security risk.

**Solution**: Use dynamic imports or configuration instead:

\`\`\`typescript
// ❌ WRONG - Security risk
const code = 'alert("XSS")'
eval(code)

// ❌ WRONG - Security risk
new Function('alert("XSS")')

// ✅ CORRECT - Safe patterns
const safeCode = JSON.parse(data)
\`\`\`

### 5. No fs Operations

**Problem**: File system operations don't work in SSR or browser rendering.

**Solution**: Only use with `typeof window !== 'undefined'` guard.

## External Composition Contract

Every external animation must:

1. **Export Props Schema**:
   \`\`\`typescript
export const PropsSchema = z.object({...})
\`\`\`

2. **Export Component**:
   \`\`\`typescript
export const MyAnimation: React.FC<Props> = ({props}) => { ... }
\`\`\`

3. **Define Default Props**:
   \`\`\`typescript
MyAnimation.defaultProps = { ... }
\`\`\`

4. **Export Registration Function**:
   \`\`\`typescript
export function registerExternalCompositions() {
  return [
    {
      id: 'MyAnimation',
      component: MyAnimation,
      defaultProps: MyAnimation.defaultProps,
      propsSchema: PropsSchema,
      width: 1920,
      height: 1080,
      fps: 30,
      durationInFrames: 90
    }
  ]
}
\`\`\`

## Common Pitfalls

### Pitfall 1: Non-Deterministic Animations

**Problem**: Using `Math.random()` makes each render different.

**Detection**: Validation error - "Math.random() found"

**Fix**: Use seeded random via props

### Pitfall 2: Timeout Errors

**Problem**: Async operations without proper handling.

**Detection**: Render timeout or error

**Fix**: Use `delayRender()`/`continueRender()`

### Pitfall 3: SSR Incompatibility

**Problem**: Using browser globals at module scope.

**Detection**: Validation error or runtime crash

**Fix**: Add `typeof` guards

### Pitfall 4: Type Errors

**Problem**: Missing props or incorrect types.

**Detection**: TypeScript compilation error or runtime error

**Fix**: Define proper interfaces and schemas

## Quick Start

### Scaffold New Animation

\`\`\`bash
# Scaffold 2D animation
npm run intake:new -- --name MyAnimation --kind 2d

# Scaffold 3D animation
npm run intake:new -- --name My3DAnim --kind 3d
\`\`\`

### Validate and Import

\`\`\`bash
# Validate
npm run intake:validate

# Import
npm run intake:import -- --source MyAnimation

# Render
npm run render -- --comp MyAnimation --out out/my-anim.mp4
\`\`\`

## Troubleshooting

### Issue: "Composition not found"

**Cause**: Composition ID doesn't match what's registered.

**Fix**:
1. Check composition ID in `apps/studio/src/Root.tsx`
2. Check `registerExternalCompositions()` returns correct ID
3. Re-run: `npm run intake:import -- --source MyAnimation`

### Issue: "Guardrail violation"

**Cause**: Code contains disallowed patterns.

**Fix**:
1. See specific violation in validation output
2. Fix the issue in your code
3. Re-run validation

### Issue: "WebGL not available"

**Cause**: Trying to render 3D animation without `--gl` flag.

**Fix**:
\`\`\`bash
npm run render -- --comp My3DAnim --out out/3d.mp4 --gl swangle
\`\`\`

### Issue: "Duration exceeds max"

**Cause**: Video is too long.

**Fix**:
1. Reduce frames: decrease `durationInFrames`
2. Increase FPS: check compatibility
3. Increase limit: `--max-duration <seconds>`

## Best Practices

1. **Keep it short**: 3-6 seconds optimal (90-180 frames at 30fps)
2. **Use interpolation**: Always use `interpolate()` for smooth animations
3. **Test locally**: Use `npm run dev` to preview before rendering
4. **Validate first**: Always run validation before importing
5. **Props validation**: Use Zod schemas for all props
6. **Deterministic**: Ensure animations are reproducible
7. **Error handling**: Handle errors gracefully with clear messages

## Support

For issues or questions:
- Check `docs/troubleshooting.md` for common solutions
- Review `prompts/animation-codegen.md` for code generation guidelines
- Check guardrails explanation above for detailed fixes
